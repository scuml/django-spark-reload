var HotwireSpark=function(t){"use strict";function e(t){return document.querySelector(`meta[name="hotwire-spark:${t}"]`)?.content}var o={loggingEnabled:e("logging")??!1,htmlReloadMethod:e("html-reload-method"),cableServerPath:e("cable-server-path")},n={logger:"undefined"!=typeof console?console:void 0,WebSocket:"undefined"!=typeof WebSocket?WebSocket:void 0},i={log(...t){this.enabled&&(t.push(Date.now()),n.logger.log("[ActionCable]",...t))}};const s=()=>(new Date).getTime(),r=t=>(s()-t)/1e3;class c{constructor(t){this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.reconnectAttempts=0}start(){this.isRunning()||(this.startedAt=s(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),i.log(`ConnectionMonitor started. stale threshold = ${this.constructor.staleThreshold} s`))}stop(){this.isRunning()&&(this.stoppedAt=s(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),i.log("ConnectionMonitor stopped"))}isRunning(){return this.startedAt&&!this.stoppedAt}recordMessage(){this.pingedAt=s()}recordConnect(){this.reconnectAttempts=0,delete this.disconnectedAt,i.log("ConnectionMonitor recorded connect")}recordDisconnect(){this.disconnectedAt=s(),i.log("ConnectionMonitor recorded disconnect")}startPolling(){this.stopPolling(),this.poll()}stopPolling(){clearTimeout(this.pollTimeout)}poll(){this.pollTimeout=setTimeout((()=>{this.reconnectIfStale(),this.poll()}),this.getPollInterval())}getPollInterval(){const{staleThreshold:t,reconnectionBackoffRate:e}=this.constructor;return 1e3*t*Math.pow(1+e,Math.min(this.reconnectAttempts,10))*(1+(0===this.reconnectAttempts?1:e)*Math.random())}reconnectIfStale(){this.connectionIsStale()&&(i.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, time stale = ${r(this.refreshedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`),this.reconnectAttempts++,this.disconnectedRecently()?i.log(`ConnectionMonitor skipping reopening recent disconnect. time disconnected = ${r(this.disconnectedAt)} s`):(i.log("ConnectionMonitor reopening"),this.connection.reopen()))}get refreshedAt(){return this.pingedAt?this.pingedAt:this.startedAt}connectionIsStale(){return r(this.refreshedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&r(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){"visible"===document.visibilityState&&setTimeout((()=>{!this.connectionIsStale()&&this.connection.isOpen()||(i.log(`ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = ${document.visibilityState}`),this.connection.reopen())}),200)}}c.staleThreshold=6,c.reconnectionBackoffRate=.15;var l={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart",remote:"remote"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]};const{message_types:a,protocols:h}=l,d=h.slice(0,h.length-1),u=[].indexOf;class p{constructor(t){this.open=this.open.bind(this),this.consumer=t,this.subscriptions=this.consumer.subscriptions,this.monitor=new c(this),this.disconnected=!0}send(t){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(t)),!0)}open(){if(this.isActive())return i.log(`Attempted to open WebSocket, but existing socket is ${this.getState()}`),!1;{const t=[...h,...this.consumer.subprotocols||[]];return i.log(`Opening WebSocket, current state is ${this.getState()}, subprotocols: ${t}`),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new n.WebSocket(this.consumer.url,t),this.installEventHandlers(),this.monitor.start(),!0}}close({allowReconnect:t}={allowReconnect:!0}){if(t||this.monitor.stop(),this.isOpen())return this.webSocket.close()}reopen(){if(i.log(`Reopening WebSocket, current state is ${this.getState()}`),!this.isActive())return this.open();try{return this.close()}catch(t){i.log("Failed to reopen WebSocket",t)}finally{i.log(`Reopening WebSocket in ${this.constructor.reopenDelay}ms`),setTimeout(this.open,this.constructor.reopenDelay)}}getProtocol(){if(this.webSocket)return this.webSocket.protocol}isOpen(){return this.isState("open")}isActive(){return this.isState("open","connecting")}triedToReconnect(){return this.monitor.reconnectAttempts>0}isProtocolSupported(){return u.call(d,this.getProtocol())>=0}isState(...t){return u.call(t,this.getState())>=0}getState(){if(this.webSocket)for(let t in n.WebSocket)if(n.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase();return null}installEventHandlers(){for(let t in this.events){const e=this.events[t].bind(this);this.webSocket[`on${t}`]=e}}uninstallEventHandlers(){for(let t in this.events)this.webSocket[`on${t}`]=function(){}}}p.reopenDelay=500,p.prototype.events={message(t){if(!this.isProtocolSupported())return;const{identifier:e,message:o,reason:n,reconnect:s,type:r}=JSON.parse(t.data);switch(this.monitor.recordMessage(),r){case a.welcome:return this.triedToReconnect()&&(this.reconnectAttempted=!0),this.monitor.recordConnect(),this.subscriptions.reload();case a.disconnect:return i.log(`Disconnecting. Reason: ${n}`),this.close({allowReconnect:s});case a.ping:return null;case a.confirmation:return this.subscriptions.confirmSubscription(e),this.reconnectAttempted?(this.reconnectAttempted=!1,this.subscriptions.notify(e,"connected",{reconnected:!0})):this.subscriptions.notify(e,"connected",{reconnected:!1});case a.rejection:return this.subscriptions.reject(e);default:return this.subscriptions.notify(e,"received",o)}},open(){if(i.log(`WebSocket onopen event, using '${this.getProtocol()}' subprotocol`),this.disconnected=!1,!this.isProtocolSupported())return i.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close(t){if(i.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error(){i.log("WebSocket onerror event")}};class g{constructor(t,e={},o){this.consumer=t,this.identifier=JSON.stringify(e),function(t,e){if(null!=e)for(let o in e){const n=e[o];t[o]=n}}(this,o)}perform(t,e={}){return e.action=t,this.send(e)}send(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})}unsubscribe(){return this.consumer.subscriptions.remove(this)}}class m{constructor(t){this.subscriptions=t,this.pendingSubscriptions=[]}guarantee(t){-1==this.pendingSubscriptions.indexOf(t)?(i.log(`SubscriptionGuarantor guaranteeing ${t.identifier}`),this.pendingSubscriptions.push(t)):i.log(`SubscriptionGuarantor already guaranteeing ${t.identifier}`),this.startGuaranteeing()}forget(t){i.log(`SubscriptionGuarantor forgetting ${t.identifier}`),this.pendingSubscriptions=this.pendingSubscriptions.filter((e=>e!==t))}startGuaranteeing(){this.stopGuaranteeing(),this.retrySubscribing()}stopGuaranteeing(){clearTimeout(this.retryTimeout)}retrySubscribing(){this.retryTimeout=setTimeout((()=>{this.subscriptions&&"function"==typeof this.subscriptions.subscribe&&this.pendingSubscriptions.map((t=>{i.log(`SubscriptionGuarantor resubscribing ${t.identifier}`),this.subscriptions.subscribe(t)}))}),500)}}class f{constructor(t){this.consumer=t,this.guarantor=new m(this),this.subscriptions=[]}create(t,e){const o="object"==typeof t?t:{channel:t},n=new g(this.consumer,o,e);return this.add(n)}add(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.subscribe(t),t}remove(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t}reject(t){return this.findAll(t).map((t=>(this.forget(t),this.notify(t,"rejected"),t)))}forget(t){return this.guarantor.forget(t),this.subscriptions=this.subscriptions.filter((e=>e!==t)),t}findAll(t){return this.subscriptions.filter((e=>e.identifier===t))}reload(){return this.subscriptions.map((t=>this.subscribe(t)))}notifyAll(t,...e){return this.subscriptions.map((o=>this.notify(o,t,...e)))}notify(t,e,...o){let n;return n="string"==typeof t?this.findAll(t):[t],n.map((t=>"function"==typeof t[e]?t[e](...o):void 0))}subscribe(t){this.sendCommand(t,"subscribe")&&this.guarantor.guarantee(t)}confirmSubscription(t){i.log(`Subscription confirmed ${t}`),this.findAll(t).map((t=>this.guarantor.forget(t)))}sendCommand(t,e){const{identifier:o}=t;return this.consumer.send({command:e,identifier:o})}}class b{constructor(t){this._url=t,this.subscriptions=new f(this),this.connection=new p(this),this.subprotocols=[]}get url(){return function(t){"function"==typeof t&&(t=t());if(t&&!/^wss?:/i.test(t)){const e=document.createElement("a");return e.href=t,e.href=e.href,e.protocol=e.protocol.replace("http","ws"),e.href}return t}(this._url)}send(t){return this.connection.send(t)}connect(){return this.connection.open()}disconnect(){return this.connection.close({allowReconnect:!1})}ensureActiveConnection(){if(!this.connection.isActive())return this.connection.open()}addSubProtocol(t){this.subprotocols=[...this.subprotocols,t]}}var S=function(t=function(t){const e=document.head.querySelector(`meta[name='action-cable-${t}']`);if(e)return e.getAttribute("content")}("url")||l.default_mount_path){return new b(t)}(o.cableServerPath);function w(t){return t.replace(/-[a-z0-9]+\.(\w+)(\?.*)?$/,".$1")}function y(t,e){const o=new URL(t,window.location.origin);return Object.entries(e).forEach((t=>{let[e,n]=t;o.searchParams.set(e,n)})),o.toString()}function v(t){return y(t,{reload:Date.now()})}async function k(){let t=v(y(window.location.href,{hotwire_spark:"true"}));const e=await fetch(t,{headers:{Accept:"text/html"}});if(!e.ok)throw new Error(`${e.status} when fetching ${t}`);const o=await e.text();return(new DOMParser).parseFromString(o,"text/html")}function A(){if(o.loggingEnabled){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];console.log("[hotwire_spark]",...e)}}class C{static async reload(t){const e=await k();return new C(e,t).reload()}static async reloadAll(){return Stimulus.controllers.forEach((t=>{Stimulus.unload(t.identifier),Stimulus.register(t.identifier,t.constructor)})),Promise.resolve()}constructor(t,e){this.document=t,this.changedFilePath=e,this.application=window.Stimulus}async reload(){A("Reload Stimulus controllers..."),this.application.stop(),await this.#t(),this.#e(),this.application.start()}async#t(){await Promise.all(this.#o.map((async t=>this.#n(t))))}get#o(){return this.controllerPathsToReload=this.controllerPathsToReload||this.#i.filter((t=>this.#s(t))),this.controllerPathsToReload}get#i(){return Object.keys(this.#r).filter((t=>t.endsWith("_controller")))}#s(t){return this.#c(t)===this.#l}get#l(){return this.changedControllerIdentifier=this.changedControllerIdentifier||this.#c(this.changedFilePath),this.changedControllerIdentifier}get#r(){return this.pathsByModule=this.pathsByModule||this.#a(),this.pathsByModule}#a(){const t=this.document.querySelector("script[type=importmap]");return JSON.parse(t.text).imports}async#n(t){A(`\t${t}`);const e=this.#c(t),o=v(this.#h(t)),n=await import(o);this.#d(e,n)}#e(){this.#u.forEach((t=>this.#p(t.identifier)))}get#u(){return this.#g?[]:this.application.controllers.filter((t=>this.#l===t.identifier))}get#g(){return this.#o.length>0}#h(t){return this.#r[t]}#c(t){return t.replace(/^\/+/,"").replace(/^controllers\//,"").replace("_controller","").replace(/\//g,"--").replace(/_/g,"-").replace(/\.js$/,"")}#d(t,e){this.application.unload(t),this.application.register(t,e.default)}#p(t){A(`\tRemoving controller ${t}`),this.application.unload(t)}}class P{static async reload(){return(new P).reload()}async reload(){await this.#m(),await this.#f()}async#m(){A("Reload html with morph...");const t=await k();return this.#b(t.body),t}#b(e){t.Idiomorph.morph(document.body,e)}async#f(){await C.reloadAll()}}class R{static async reload(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return new R(...e).reload()}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:/./;this.filePattern=t}async reload(){A("Reload css..."),await Promise.all(await this.#S())}async#S(){return(await this.#w()).map((t=>this.#y(t)))}async#w(){const t=await k();return Array.from(t.head.querySelectorAll("link[rel='stylesheet']"))}#y(t){return this.#v(t)?this.#k(t):Promise.resolve()}#v(t){return this.filePattern.test(t.getAttribute("href"))}async#k(t){return new Promise((e=>{const o=t.getAttribute("href"),n=this.#A(t)||this.#C(t);n.setAttribute("href",v(t.getAttribute("href"))),n.onload=()=>{A(`\t${o}`),e()}}))}#A(t){return this.#P.find((e=>w(t.href)===w(e.href)))}get#P(){return Array.from(document.querySelectorAll("link[rel='stylesheet']"))}#C(t){return document.head.append(t),t}}class T{static async reload(){return(new T).reload()}async reload(){await this.#m()}async#m(){A("Reload html with Turbo..."),this.#R(),await this.#T()}#R(){document.addEventListener("turbo:before-render",(()=>{Turbo.navigator.currentVisit.scrolled=!0}),{once:!0})}#T(){return new Promise((t=>{document.addEventListener("turbo:load",(()=>t(document)),{once:!0}),window.Turbo.visit(window.location)}))}}S.subscriptions.create({channel:"Hotwire::Spark::Channel"},{connected(){document.body.setAttribute("data-hotwire-spark-ready","")},async received(t){try{await this.dispatch(t)}catch(e){console.log(`Error on ${t.action}`,e)}},dispatch(t){let{action:e,path:o}=t;switch(e){case"reload_html":return this.reloadHtml();case"reload_css":return this.reloadCss(o);case"reload_stimulus":return this.reloadStimulus(o);default:throw new Error(`Unknown action: ${e}`)}},reloadHtml:()=>("morph"==HotwireSpark.config.htmlReloadMethod?P:T).reload(),reloadCss(t){const e=function(t){return t.split("/").pop().split(".")[0]}(t);return R.reload(new RegExp(e))},reloadStimulus:t=>C.reload(t)});{console.info("I'm here");const t=document.currentScript.dataset,e=t.workerScriptPath,o=t.eventsPath;if(window.SharedWorker){const t=new SharedWorker(e,{name:"django-browser-reload"});console.info("Listening"),t.port.addEventListener("message",(t=>{const e=t.data,o=e.type,n=e.path;console.info("Reload",o,n),"reload"===o?(console.info("Hard Reload"),window.location.reload()):"softreload"===o?(console.info("Soft Reload"),HotwireSpark.reloadHtml()):"reloadcss"===o?(console.info("ReloadCSS",n),HotwireSpark.reloadCss(n)):"reloadstimulus"===o&&(console.info("ReloadStimulus",n),HotwireSpark.reloadStimulus(n))})),t.port.postMessage({type:"initialize",eventsPath:o}),t.port.start()}else console.debug("😭 django-browser-reload cannot work in this browser.")}return{config:o}}(idiomorph_esm_js);
//# sourceMappingURL=hotwire_spark.min.js.map
